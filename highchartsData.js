var seriesData = [{
    "Id": "734",
    "Name": "Programmatic Digital Display Ad Spending (% of total digital display ad spending)",
    "Note": "digital display ads transacted via an API, including everything from publisher-erected APIs to more standardized RTB technology; includes advertising that appears on desktop/laptop computers as well as mobile phones and tablets",
    "Chart": false,
    "Type": "Percentage",
    "Values": [
        45,
        55,
        63,
        null,
        null
    ],
    "HasData": true,
    "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "103",
  "Name": "Directory Ad Spending Pluse Extra Crap to Make this long (Billions)",
  "Note": "print only; includes yellow pages and other",
  "Chart": false,
  "Type": "Currency",
  "Values": [
    4.9,
    4.56,
    4.25,
    4.08,
    4.95
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
},
{
    "Id": "353",
    "Name": "Directory Ad Spending (% of total media ad spending)",
    "Note": "print only; includes yellow pages and other",
    "Chart": false,
    "Type": "Percentage",
    "Values": [
        2.8,
        2.4,
        2.1,
        2,
        1.8
    ],
    "HasData": true,
    "PublishedAt": "2015-03-01T05:00:00Z"
},
{
    "Id": "145",
    "Name": "Directory Ad Spending Growth",
    "Note": "print only; includes yellow pages and other",
    "Chart": false,
    "Type": "Percentage",
    "Values": [
        -7.5,
        -7,
        -6.8,
        -4,
        -3
    ],
    "HasData": true,
    "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "67",
  "Name": "Magazine  Ad Spending (Billions)",
  "Note": "includes B2B, consumer, local and Sunday; print only",
  "Chart": false,
  "Type": "Currency",
  "Values": [
    15.09,
    15.05,
    15.1,
    15.15,
    15.23
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "127",
  "Name": "Magazine Ad Spending Growth",
  "Note": "includes B2B, consumer, local and Sunday; print only",
  "Chart": false,
  "Type": "Percentage",
  "Values": [
    -0.3,
    -0.2,
    0.3,
    0.4,
    0.5
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
},
{
    "Id": "351",
    "Name": "Magazine Ad Spending (% of total media ad spending)",
    "Note": "includes B2B, consumer, local and Sunday; print only",
    "Chart": false,
    "Type": "Percentage",
    "Values": [
        8.5,
        8,
        7.6,
        7.3,
        6.9
    ],
    "HasData": true,
    "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "63",
  "Name": "Newspaper Ad Spending (Billions)",
  "Note": "includes classifieds, national and retail; print only; eMarketer benchmarks its US newspaper ad spending projections against the Newspaper Association of America (NAA) data for which the last full year measured was 2013",
  "Chart": false,
  "Type": "Currency",
  "Values": [
    16.61,
    16.12,
    15.79,
    15.63,
    15.63
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "350",
  "Name": "Newspaper Ad Spending (% of total media ad spending)",
  "Note": "includes classifieds, national and retail; print only; eMarketer benchmarks its US newspaper ad spending projections against the NAA, for which the last full year measured was 2013",
  "Chart": false,
  "Type": "Percentage",
  "Values": [
    9.3,
    8.6,
    7.9,
    7.5,
    7.1
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
},
{
    "Id": "128",
    "Name": "Newspaper Ad Spending Growth",
    "Note": "includes classifieds, national and retail; print only; eMarketer benchmarks its US newspaper ad spending projections against the Newspaper Association of America (NAA) data for which the last full year measured was 2013",
    "Chart": false,
    "Type": "Percentage",
    "Values": [
        -4,
        null,
        -2,
        -1,
        0
    ],
    "HasData": true,
    "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "64",
  "Name": "Outdoor Ad Spending (Billions)",
  "Note": "includes alternative, billboards, cinema, street furniture and transit; eMarketer benchmarks its outdoor ad spending for the US against the Outdoor Advertising Association of America (OAAA) data for which the last full year measured was 2013",
  "Chart": false,
  "Type": "Currency",
  "Values": [
    7.17,
    7.39,
    7.58,
    7.73,
    7.85
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
},
{
    "Id": "354",
    "Name": "Outdoor Ad Spending (% of total media ad spending)",
    "Note": "includes alternative, billboards, cinema, street furniture and transit; eMarketer benchmarks its US outdoor ad spending projections against the OAAA, for which the last full year measured was 2013",
    "Chart": false,
    "Type": "Percentage",
    "Values": [
        4,
        3.9,
        3.8,
        3.7,
        3.6
    ],
    "HasData": true,
    "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "129",
  "Name": "Outdoor Ad Spending Growth",
  "Note": "includes alternative, billboards, cinema, street furniture and transit; eMarketer benchmarks its outdoor ad spending for the US against the Outdoor Advertising Association of America (OAAA) data for which the last full year measured was 2013",
  "Chart": false,
  "Type": "Percentage",
  "Values": [
    3.1,
    3.0,
    2.6,
    2.0,
    1.5
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "61",
  "Name": "TV Ad Spending (Billions)",
  "Note": "includes broadcast (network, spot and syndication) and cable TV",
  "Chart": false,
  "Type": "Currency",
  "Values": [
    68.54,
    70.59,
    73.77,
    75.98,
    78.64
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
},
{
    "Id": "348",
    "Name": "TV Ad Spending (% of total media ad spending)",
    "Note": "includes broadcast (network, spot and syndication) and cable TV",
    "Chart": false,
    "Type": "Percentage",
    "Values": [
        38.5,
        37.7,
        37.1,
        36.4,
        35.8
    ],
    "HasData": true,
    "PublishedAt": "2015-03-01T05:00:00Z"
},
{
    "Id": "131",
    "Name": "TV Ad Spending Growth",
    "Note": "includes broadcast (network, spot and syndication) and cable TV",
    "Chart": false,
    "Type": "Percentage",
    "Values": [
        3.3,
        3,
        4.5,
        3,
        3.5
    ],
    "HasData": true,
    "PublishedAt": "2015-03-01T05:00:00Z"
},
{
  "Id": "25",
  "Name": "Total Media Ad Spending (Billions)",
  "Note": "includes digital (desktop/laptop and mobile), directories, magazines, newspapers, outdoor, radio and TV",
  "Chart": false,
  "Type": "Currency",
  "Values": [
    178.09,
    187.45,
    198.76,
    208.56,
    219.51
  ],
  "HasData": true,
  "PublishedAt": "2015-03-01T05:00:00Z"
}];

(function (H) {

    var highchartsDefaultConfig = {

        chart: {
            renderTo: 'chart', /*** The ID of the containing element **/
            zoomType       : 'xy',
            marginBottom   : 125,
            marginTop      : 37,
            spacingLeft    : 0,
            spacingRight   : 0,
            width          : 465,
            height         : 450,
            style: {
                borderTop:'2px solid #000'
            },
            events: {
                // add events upon creation
            }
        },

        title: {
            align: 'left',
            y: 13,
            x: 0,
            margin: 7,
            text: '',
            useHTML: true,
            style: {
                fontFamily: 'Helvetica, Arial, sans-serif',
                fontWeight: 'bold',
                color: '#ff0000',
                fontSize: '18px'
            }
        },

        subtitle: {
            align: 'left',
            text: '',
            useHTML: true,
            style: {
                fontFamily: 'Helvetica, Arial, sans-serif',
                fontSize: '18px',
                paddingTop: '4px',
                paddingBottom: '1px',
                display: 'block',
                width: '465px',
            }
        },

        credits: {
            enabled: true,
            text: 'Source: eMarketer Forecasting Team, 2015 (see below for complete notes and methodologies).',
            href: '',
            position: {
                align: 'left',
                x: 0,
                y: -21
            },
            style: {
                cursor: 'default',
                color: '#666666',
                fontSize: '10px',
                fontStyle: 'italic',
            }
        },

        legend: {
            layout: 'vertical',
            align: 'left',
            floating: true,
            itemStyle: {
                color: '#000',
                fontFamily: 'Arial,sans-serif',
                fontWeight: 'bold',
                fontSize: '13px'
            },
            itemMarginBottom: 7,
            borderWidth: 0,
            symbolHeight: 14,
            symbolWidth: 14,
            x: -2,
            y: -22
        },

        plotOptions: {
            column: {
                pointWidth: 65,
                pointPadding: 0,
                dataLabels: {
                    enabled: true,
                    crop: false,
                    overflow: 'none',
                    allowOverlap: true,
                    useHTML: true,
                    style: {
                        fontWeight: 'bold',
                        fontFamily: 'Arial,sans-serif',
                        fontSize: '14px',
                        color: '#000'
                    }
                },
            },
            line: {
                lineWidth: 8,
                states: {
                    hover: {
                        enabled: false
                    }
                },
                marker: {
                    lineColor: '#FF0000',
                    radius: 8,
                    states: {
                        hover: {
                            enabled: false
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    allowOverlap: true,
                    crop: false,
                    overflow: 'none',
                    format: '{y}%',
                    y: 35,
                    verticalAlign: 'bottom',
                    style: {
                        color: '#fff',
                        fontSize: '14px',
                        textShadow: 'none',
                        fontFamily: 'Arial,sans-serif',
                    }
                }
            }
        },

        xAxis: [{
            categories: ['2014', '2015', '2016', '2017', '2018'],
            labels: {
                enabled: true,
                y: 20,
                style: {
                    color: '#000',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    fontFamily: 'Arial, sans-serif'
                }
            },
            tickWidth: 0,
            lineWidth: 1
        }],

        yAxis: [{
            labels: {
                enabled: false
            },
            gridLineWidth: 0,
            minorGridLineWidth: 0,
            opposite: true,
            title: {
                text: null
            }
        },
            {
                labels: {
                    enabled: false,
                },
                gridLineWidth: 0,
                minorGridLineWidth: 0,
                title: {
                    text: null,
                },
                opposite: false
            }],

        tooltip: {
            enabled: false
        },

        navigation : {
            buttonOptions : {
                enabled: false
            }
        },

        exporting : {
            sourceWidth  : 465,
            sourceHeight : 455 // slighty bigger to give branding some room
        }

    };


    function adjustLegend(series) {

        var chartBBox = document.getElementById('chart').getBoundingClientRect();

        // get the length of the legend text box
        var legendContainers = document.getElementsByClassName('highcharts-legend-item');

        for (var i=0; i<legendContainers.length; i++) {

            var textElement = legendContainers[i].children[0],
            textBB = textElement.getBoundingClientRect();

            if ( chartBBox.right - textBB.right < 0 ) { // text too long

                var tspan = textElement.children[0],
                text = tspan.textContent,
                maxLegendTextWidth = 465 - 60, //total chart minus padding
                diff = textBB.width - maxLegendTextWidth,
                charactersPerUnit = textBB.width / text.length,
                charactersToCut = Math.floor(diff/charactersPerUnit),
                startIndex = text.length - charactersToCut,
                breakPointIndex = text.lastIndexOf(' ',startIndex),
                text1 = text.substr(0, breakPointIndex),
                text2 = text.substr(breakPointIndex + 1),
                tspan.textContent = text1,
                fontFamily = series[i].legendItem.styles.fontFamily,
                fontWeight = series[i].legendItem.styles.fontWeight,
                styledText = '<span style="font-family:' + fontFamily + '; font-weight:' + fontWeight + ';">' + text2 + '</span>';

                // var tspan2 = document.createElementNS("http://www.w3.org/2000/svg", "tspan");
                // tspan2.textContent = text2;
                // textElement.appendChild(tspan2);

                //adjust the position of the existing text
                series[i].legendItem.translate(
                    series[i].legendGroup.translateX - 4, 
                    series[i].legendGroup.translateY - 6);

                // now, add the new text box
                series[i].chart.renderer.text(
                    styledText,
                    textBB.left - chartBBox.left + 4,
                    (textBB.top - chartBBox.top) + textBB.height + 7)
                .add();

            }

        }
        
    }











    /** 
      * Highcharts by default will hide labels in the event of an overlap
      * This function handles overlapping images in a way that all data is preserved
      * It basically uses bounding boxes to detect collision then
      * makes use of the SVG translate() method to reposition labels as needed
      *
    */
    function repositionLabels(series) {

        var sc = series.length, columnSeries, lineSeries, lineMarkerRadius, chart;

        if (sc != 2) {
            return;
        }

        // TODO: how to handle extra long labels

        // TODO: handle percentages on null columns

        // we expect one series of type column and one of type line
        // single and double columns don't require these adjustments
        if (series[0].options.type === 'column' && series[1].options.type === 'line') {
            columnSeries = series[0].points;
            lineSeries = series[1].points;
            lineMarkerRadius = series[1].options.marker.radius || 9;
        } else if (series[0].options.type === 'line' && series[1].options.type === 'column') {
            columnSeries = series[1].points;
            lineSeries = series[0].points;
            lineMarkerRadius = series[0].options.marker.radius;
        } else {
            return;
        }

        for (i = 0; i < lineSeries.length; i++) {

            var lineLabel = lineSeries[i].dataLabel,
            lineLabelBottom = lineLabel.y + lineLabel.height,
            lineMarkerTop = lineSeries[i].plotY - lineMarkerRadius,
            lineMarkerBotttom = lineSeries[i].plotY + lineMarkerRadius,
            lineMarkerHeight = lineMarkerRadius * 2,
            columnLabel = columnSeries[i].dataLabel,
            columnTop = columnSeries[i].plotY,
            xAxisY = columnSeries[i].shapeArgs.height + columnSeries[i].shapeArgs.y;
            // conceptually the x axis is 0, but we need the Y value of it


            // this line label is inside the column - paint it white
            if (lineLabel.y > columnTop) {
                lineLabel.css({ color: '#fff' });
            }

            // this line label is outside the column - paint it black
            if (lineLabelBottom < columnLabel.y) {
                lineLabel.css({ color: '#000' });
            }

            // these labels overlap - push the line label down into the column and paint it black
            if (Math.abs(lineLabel.y - columnLabel.y) * 2 < (lineLabel.height + columnLabel.height)) {
                lineLabel.translate(lineLabel.translateX, columnTop);
                lineLabel.css({ color: '#fff' });
            }

            // this column label overlaps the line marker - push it above the marker
            if (Math.abs(columnLabel.y - lineMarkerTop) * 2 < columnLabel.height + lineMarkerHeight) {
                columnLabel.translate(columnLabel.translateX, lineMarkerTop - columnLabel.height);
            }

            // the line label is actually below the x axis - push it up a bit
            if (lineLabelBottom > xAxisY) {
                lineLabel.translate(lineLabel.translateX, xAxisY - lineLabel.height);
            }

        }
    }

    /** 
      * this deals with the limitations of highcharts config options
      * it makes use of the Renderer() method provided by Highcharts
      * to apply the desired look to the chart
      *
    */
    function adjustChart(series) {

        adjustLegend(series);

        var chart = series[0].chart,
        chartBBox = document.getElementById('chart').getBoundingClientRect(),
        subTitleBB = document.getElementsByClassName('highcharts-subtitle')[0].getBoundingClientRect(),
        subtitleUnderlineY = (subTitleBB.top - chartBBox.top) + subTitleBB.height,
        logo = { height: 11, width: 115 },
        logoX = chartBBox.width - logo.width,
        logoY = chartBBox.height - logo.height - 1,
        creditUnderlineY = chartBBox.height - logo.height - 4;


        //add a line under the subtitle 
        chart.renderer.path(['M', 0, subtitleUnderlineY, 'L', chartBBox.width, subtitleUnderlineY])
            .attr({
                'stroke-width': .5,
                stroke: '#000'
            })
            .add();

        //draw a line below the credit
        chart.renderer.path(['M', 0, creditUnderlineY, 'L', chartBBox.width, creditUnderlineY])
            .attr({
                'stroke-width': .5,
                stroke: '#000'
            })
            .add();

        // add branding/url
        // TODO: can this be a local path ?
        chart.renderer.image('http://i.imgur.com/n8MLoPc.gif', logoX, logoY, logo.width, logo.height).add();

        repositionLabels(series);

    }

    function buildColumnData(rawData, yAxis) {
        return {
            name            : rawData.Name,
            color           : yAxis ? '#ff0000' : '#000000',
            type            : 'column',
            data            : rawData.Values,
            yAxis           : yAxis ? 1 : 0,
            formattedLabels : rawData.FormattedValues
        };
    }

    function buildLineData(rawData) {
        return {
            name      : rawData.Name,
            color     : '#ff0000',
            type      : 'line',
            data      : rawData.Values,
            yAxis     : 1
        };
    }

    /** 
      * Highcharts automatically calculates the min/max values 
      * of a chart however, this can lead to unexpected results
      * this function gets the highest and lowest values in a series
      * and adjusts the numbers as needed.
      * TODO: it's not perfect, is there an all purpose calculation?
      *
    */
    function getExtremes(arrayA, arrayB) {

        var min, max, combinedArray, numberLength, multiplier;

        if (arrayB) {
            combinedArray = arrayA.concat(arrayB);
        } else {
            combinedArray = arrayA;
        }

        max = Math.max.apply(null, combinedArray);                   // the higest value in the series
        // adjust for the chart:
        if (max <= 0) { max = 0.1; } else                            // a max >= 0 throws everything off
        if (max < 1) { max += (max * .2); } else                     // for lower values, use a higher percentage
        if (max < 10) { max = Math.ceil(max += (max * .1)); } else   // use a lower percentage, but round it up
        max = Math.ceil(max += (max * .1));                          // for a max > 10, 10% rounded is enough

        min = Math.min.apply(null, combinedArray);                   // the lowest value in the series
        // adjusted: 
        if (min >= 0) { min = 0; } else                              // let's keep the default behavior
        min = Math.floor(min += (min * .1));                         // push the x axis down a bit

        return {
            max: max,
            min: min
        };
    }

    H.destroyDashboardChart = function () {
        if (window.dashboardChart) {
            window.dashboardChart.destroy();
            window.dashboardChart = undefined;
        }
    }

    /** 
      * Highcharts automatically calculates the min/max values 
      * of a chart however, this can lead to unexpected results
      * this function gets the highest and lowest values in a series
      * and adjusts the numbers as needed
      *
    */
    H.createDashboardChart = function (title, subtitle, rawSeriesData) {

        H.destroyDashboardChart();

        // TODO: we may want to, based on the length of the title/subtitle
        // preemptively adjust the chart to prevent overlap.
        var title = title || '',
        subtitle = subtitle || '',
        series = [],
        extremes,
        chartConfig = JSON.parse(JSON.stringify(highchartsDefaultConfig));


        if (rawSeriesData.length < 1 || rawSeriesData.length > 2) {
            return;
        }

        if (rawSeriesData.length == 1) {
            /**
             *
             *   SINGLE COLUMN
             *
             **/
            series.push(buildColumnData(rawSeriesData[0]));
            extremes = getExtremes(rawSeriesData[0].Values);
            chartConfig.chart.alignTicks = false;
            chartConfig.chart.marginBottom = 105;
            chartConfig.yAxis[0].max = extremes.max;
            chartConfig.yAxis[0].min = extremes.min;


        } else {

            extremes = getExtremes(rawSeriesData[0].Values, rawSeriesData[1].Values);

            /** When one but not both types are percentage
             *
             *   BAR - LINE 
             *
             **/
            if ((rawSeriesData[0].Type === 'Percentage' || rawSeriesData[1].Type === 'Percentage')
                    && (rawSeriesData[0].Type != rawSeriesData[1].Type)) {


                if (rawSeriesData[0].Type === 'Percentage') {
                    // push line data last, so it's one top, or, set the z index
                    series.push(buildColumnData(rawSeriesData[1]));
                    series.push(buildLineData(rawSeriesData[0]));
                    extremes = getExtremes(rawSeriesData[1].Values);
                    chartConfig.yAxis[0].max = extremes.max;
                } else {
                    // push line data last, so it's one top, or, set the z index
                    series.push(buildColumnData(rawSeriesData[0]));
                    series.push(buildLineData(rawSeriesData[1]));
                    extremes = getExtremes(rawSeriesData[0].Values);
                    chartConfig.yAxis[0].max = extremes.max;
                }

                chartConfig.yAxis[1].max = 50; // push down the percentage line
                chartConfig.chart.alignTicks = false;

            } else {

                /**
                 *   Neither type is a percentage
                 *   DOUBLE COLUMN
                 *
                 **/
                series.push(buildColumnData(rawSeriesData[0]));
                series.push(buildColumnData(rawSeriesData[1], true));

                chartConfig.plotOptions.column.pointWidth = undefined;
                chartConfig.plotOptions.column.groupPadding = 0.1;
                chartConfig.plotOptions.column.dataLabels.style.fontSize = '12px';
                chartConfig.chart.alignTicks = false;
                chartConfig.yAxis[0].max = extremes.max;
                chartConfig.yAxis[1].max = extremes.max;
                chartConfig.yAxis[0].min = extremes.min;
                chartConfig.yAxis[1].min = extremes.min;

            }


        }

        // set top level options
        chartConfig.title.text = title;
        chartConfig.subtitle.text = subtitle;
        chartConfig.series = series;

        // add the necessary callbacks
        chartConfig.chart.events.load = function () {
            adjustChart(this.series);
        };

        chartConfig.chart.events.redraw = function () {
            var series = this.series;
            setTimeout(function () {
                adjustChart(series);
            }, 500); //because of the animation
        };

        chartConfig.plotOptions.column.dataLabels.formatter = function () {
            return this.y;
        };

        window.dashboardChart = new Highcharts.Chart(chartConfig);

    }

    return H;


}(Highcharts));

$(document).ready(function(){

    $.each(seriesData, function(index, item){
      var el = '<div><input type="checkbox" id="id-' + item.Id + '"><label for="id-' + item.Id + '">' + item.Name + '</label></div>';
      $('#series-data').append(el);
    });

    $('#series-data input').click(function(){
        var selectedData = [];

        if ( !$('#series-data input:checked').size() ) {
            Highcharts.destroyDashboardChart();
            return;
        }

        if ( $('#series-data input:checked').size() == 2 ) {
          $('#series-data input:not(:checked)').attr('disabled',true);
        } else {
            $('#series-data input').removeAttr('disabled');
        }

        $('#series-data input:checked').each(function(index, el){
            var i = $(this).parent().index();
            selectedData.push(seriesData[i]);

        });
                
        Highcharts.createDashboardChart('Title', 'subtitle', selectedData);

    });

    //$('#export-chart button').click(function(e){
    //    e.preventDefault();
   //     myChart.exportChart();
   // });

});